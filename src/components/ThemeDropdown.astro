---
import type { ThemeContent } from "../types/content";

interface Props {
  theme: ThemeContent;
}

const { theme } = Astro.props;
const lightThemes = theme.options.filter((option) => option.tone === "light");
const darkThemes = theme.options.filter((option) => option.tone === "dark");
const accentByThemeId: Record<string, string> = {
  "light-red": "#a8423b",
  "light-blue": "#2f6f9e",
  "light-green": "#2f7648",
  "light-yellow": "#8f6a1e",
  "dark-red": "#d97b72",
  "dark-blue": "#77b3df",
  "dark-green": "#79c193",
  "dark-yellow": "#d4b062"
};
---

<details class="preferences-dropdown theme-dropdown">
  <summary class="theme-toggle preferences-dropdown__summary" aria-label={theme.themeLabel}>
    <svg class="theme-toggle__icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <path d="M12 3v2.3M12 18.7V21M4.9 4.9l1.6 1.6M17.5 17.5l1.6 1.6M3 12h2.3M18.7 12H21M4.9 19.1l1.6-1.6M17.5 6.5l1.6-1.6M12 16.2a4.2 4.2 0 1 0 0-8.4a4.2 4.2 0 0 0 0 8.4z"></path>
    </svg>
    <span class="theme-toggle__text">{theme.themeLabel}</span>
  </summary>

  <div class="preferences-dropdown__panel">
    <p class="preferences-dropdown__heading">{theme.themeLabel}</p>

    <p class="preferences-dropdown__subheading">{theme.lightGroupLabel}</p>
    <div class="preferences-dropdown__options">
      {lightThemes.map((option) => (
        <button
          class="preferences-dropdown__option preferences-dropdown__option--theme"
          type="button"
          data-theme-option={option.id}
          style={`--theme-option-accent: ${accentByThemeId[option.id] ?? "#a8423b"}`}
        >
          <span class="preferences-dropdown__swatch" aria-hidden="true"></span>
          <span>{option.label}</span>
        </button>
      ))}
    </div>

    <p class="preferences-dropdown__subheading">{theme.darkGroupLabel}</p>
    <div class="preferences-dropdown__options">
      {darkThemes.map((option) => (
        <button
          class="preferences-dropdown__option preferences-dropdown__option--theme"
          type="button"
          data-theme-option={option.id}
          style={`--theme-option-accent: ${accentByThemeId[option.id] ?? "#a8423b"}`}
        >
          <span class="preferences-dropdown__swatch" aria-hidden="true"></span>
          <span>{option.label}</span>
        </button>
      ))}
    </div>
  </div>
</details>

<script is:inline define:vars={{ storageKey: theme.storageKey }}>
  const themeDropdowns = document.querySelectorAll(".theme-dropdown");

  const syncActiveTheme = (scope) => {
    const root = document.documentElement;
    const activeTheme = root.dataset.theme ?? "";
    const optionButtons = scope.querySelectorAll("[data-theme-option]");

    for (const optionButton of optionButtons) {
      if (!(optionButton instanceof HTMLButtonElement)) {
        continue;
      }

      const themeId = optionButton.dataset.themeOption ?? "";
      const isActive = themeId === activeTheme;
      optionButton.classList.toggle("preferences-dropdown__option--active", isActive);
      optionButton.setAttribute("aria-pressed", isActive ? "true" : "false");
    }
  };

  const syncAllThemes = () => {
    for (const dropdown of themeDropdowns) {
      if (!(dropdown instanceof HTMLDetailsElement)) {
        continue;
      }

      syncActiveTheme(dropdown);
    }
  };

  for (const dropdown of themeDropdowns) {
    if (!(dropdown instanceof HTMLDetailsElement)) {
      continue;
    }

    dropdown.addEventListener("toggle", () => {
      if (!dropdown.open) {
        return;
      }

      const allDropdowns = document.querySelectorAll(".preferences-dropdown");
      for (const otherDropdown of allDropdowns) {
        if (otherDropdown !== dropdown && otherDropdown instanceof HTMLDetailsElement) {
          otherDropdown.open = false;
        }
      }
    });

    const themeButtons = dropdown.querySelectorAll("[data-theme-option]");
    for (const themeButton of themeButtons) {
      if (!(themeButton instanceof HTMLButtonElement)) {
        continue;
      }

      themeButton.addEventListener("click", () => {
        const themeId = themeButton.dataset.themeOption;
        if (!themeId) {
          return;
        }

        document.documentElement.dataset.theme = themeId;
        window.localStorage.setItem(storageKey, themeId);
        syncAllThemes();
        dropdown.open = false;
      });
    }

    document.addEventListener("click", (event) => {
      if (!dropdown.open) {
        return;
      }

      if (event.target instanceof Node && !dropdown.contains(event.target)) {
        dropdown.open = false;
      }
    });
  }

  syncAllThemes();
</script>
